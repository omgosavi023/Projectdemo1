<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Project INCOPs</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(45deg, #0f0c29, #302b63, #24243e);
            color: white;
            min-height: 100vh;
        }
        
        .navbar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #00d2ff;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .logout-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .logout-btn:hover {
            background: #ff3742;
        }
        
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        
        .welcome-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .welcome-card h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(45deg, #00d2ff, #3a7bd5);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .card:hover {
            transform: translateY(-5px);
            border-color: #00d2ff;
            box-shadow: 0 15px 30px rgba(0, 210, 255, 0.2);
        }
        
        .card h3 {
            color: #00d2ff;
            margin-bottom: 1rem;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card h3:before {
            content: "‚ñ∏";
        }
        
        .card ul {
            list-style: none;
            padding-left: 0;
        }
        
        .card li {
            margin-bottom: 0.8rem;
            padding-left: 1.5rem;
            position: relative;
        }
        
        .card li:before {
            content: "‚úì";
            color: #00d2ff;
            position: absolute;
            left: 0;
            font-weight: bold;
        }
        
        .status-badge {
            display: inline-block;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-top: 1rem;
        }
        
        .status-running {
            background: rgba(0, 255, 0, 0.2);
            color: #00ff00;
            border: 1px solid rgba(0, 255, 0, 0.3);
        }
        
        .status-pending {
            background: rgba(255, 255, 0, 0.2);
            color: #ffff00;
            border: 1px solid rgba(255, 255, 0, 0.3);
        }
        
        .status-warning {
            background: rgba(255, 165, 0, 0.2);
            color: #ffa500;
            border: 1px solid rgba(255, 165, 0, 0.3);
        }
        
        .api-test-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 2rem;
            margin-top: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .api-test-section h2 {
            color: #00d2ff;
            margin-bottom: 1.5rem;
        }
        
        .button-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }
        
        .api-btn {
            background: #8e44ad;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .api-btn:hover {
            background: #9b59b6;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(142, 68, 173, 0.4);
        }
        
        .api-btn.success {
            background: #27ae60;
        }
        
        .api-btn.success:hover {
            background: #2ecc71;
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
        }
        
        .api-btn.danger {
            background: #c0392b;
        }
        
        .api-btn.danger:hover {
            background: #e74c3c;
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }
        
        .result-box {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1.5rem;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #00d2ff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(45deg, #00d2ff, #3a7bd5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #00d2ff;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #ccc;
        }
        
        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }
            
            .container {
                padding: 1rem;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .api-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo">üöÄ Project INCOPs</div>
        <div class="user-info">
            <div class="user-avatar" id="userAvatar">A</div>
            <div>
                <div id="usernameDisplay">Loading...</div>
                <div id="userRole" style="font-size: 0.8rem; color: #ccc;">Role: Loading...</div>
            </div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </nav>
    
    <div class="container">
        <div class="welcome-card">
            <h1>Welcome to Project INCOPs Dashboard</h1>
            <p>Secure DevSecOps Pipeline for Microservices-based Web Applications</p>
            
            <div class="stats-grid" id="statsGrid">
                <!-- Stats will be loaded dynamically -->
            </div>
            
            <div id="backendStatus" style="margin-top: 1.5rem; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 8px;">
                <span class="loading"></span> Checking backend status...
            </div>
        </div>
        
        <div class="dashboard-grid">
            <div class="card">
                <h3>CI/CD Pipeline</h3>
                <ul>
                    <li>Automated Build & Test</li>
                    <li>Container Registry Integration</li>
                    <li>Kubernetes Deployment</li>
                    <li>Rollback Capabilities</li>
                    <li>GitOps Workflow</li>
                </ul>
                <div class="status-badge status-running">Active</div>
            </div>
            
            <div class="card">
                <h3>Security Scanning</h3>
                <ul>
                    <li>SAST (Static Application Security Testing)</li>
                    <li>DAST (Dynamic Application Security Testing)</li>
                    <li>Container Vulnerability Scan</li>
                    <li>Secrets Detection & Management</li>
                    <li>Dependency Scanning</li>
                </ul>
                <div class="status-badge status-running">Scanning Active</div>
            </div>
            
            <div class="card">
                <h3>Monitoring Stack</h3>
                <ul>
                    <li>Prometheus Metrics Collection</li>
                    <li>Grafana Dashboards</li>
                    <li>ELK Stack Logging</li>
                    <li>Real-time Alerts</li>
                    <li>Performance Analytics</li>
                </ul>
                <div class="status-badge status-pending">Configuring</div>
            </div>
            
            <div class="card">
                <h3>Microservices</h3>
                <ul>
                    <li>Authentication Service (JWT)</li>
                    <li>Deployment Service</li>
                    <li>Monitoring Service</li>
                    <li>Security Scanning Service</li>
                    <li>Secret Management Service</li>
                </ul>
                <div class="status-badge status-running">4/5 Running</div>
            </div>
            
            <div class="card">
                <h3>Kubernetes Integration</h3>
                <ul>
                    <li>Auto-scaling Pods</li>
                    <li>Service Mesh (Istio)</li>
                    <li>ConfigMaps & Secrets</li>
                    <li>Health Checks</li>
                    <li>Canary Deployments</li>
                </ul>
                <div class="status-badge status-warning">Partial</div>
            </div>
            
            <div class="card">
                <h3>Compliance & Audit</h3>
                <ul>
                    <li>Audit Logging</li>
                    <li>Compliance Reports</li>
                    <li>Security Policy Enforcement</li>
                    <li>Access Control (RBAC)</li>
                    <li>Incident Response</li>
                </ul>
                <div class="status-badge status-pending">Setup Required</div>
            </div>
        </div>
        
        <div class="api-test-section">
            <h2>üîß API Testing Panel</h2>
            <p>Test your backend API endpoints with JWT authentication</p>
            
            <div class="button-group">
                <button class="api-btn" onclick="testHealthEndpoint()">
                    Test Health Endpoint
                </button>
                <button class="api-btn success" onclick="testProtectedEndpoint()">
                    Test Protected Route
                </button>
                <button class="api-btn" onclick="testAdminEndpoint()">
                    Test Admin Route
                </button>
                <button class="api-btn danger" onclick="clearLocalStorage()">
                    Clear Local Storage
                </button>
            </div>
            
            <div id="apiResult" class="result-box">
                API results will appear here...
            </div>
        </div>
        
        <div class="card" style="margin-top: 2rem;">
            <h3>üìä Recent Activity</h3>
            <div id="recentActivity">
                <p>Loading recent activity...</p>
            </div>
            <button onclick="loadRecentActivity()" style="
                background: #3498db;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 5px;
                cursor: pointer;
                margin-top: 1rem;
            ">
                Refresh Activity
            </button>
        </div>
    </div>
    
    <script>
        // ==================== AUTH FUNCTIONS ====================
        
        // Check if user is logged in
        function checkAuth() {
            const token = localStorage.getItem('incops_token');
            const user = localStorage.getItem('incops_user');
            
            if (!token || !user) {
                alert('‚ö†Ô∏è Please login first');
                window.location.href = 'index.html';
                return null;
            }
            
            try {
                const userData = JSON.parse(user);
                
                // Check token expiry if stored
                const expiry = localStorage.getItem('incops_token_expiry');
                if (expiry && Date.now() > parseInt(expiry)) {
                    logout();
                    return null;
                }
                
                return { token, user: userData };
            } catch (e) {
                console.error('Error parsing user data:', e);
                logout();
                return null;
            }
        }
        
        // Display user info on dashboard
        function displayUserInfo() {
            const auth = checkAuth();
            if (!auth) return;
            
            const { user } = auth;
            
            // Display username and role
            document.getElementById('usernameDisplay').textContent = user.username;
            document.getElementById('userRole').textContent = `Role: ${user.role.toUpperCase()}`;
            
            // Set avatar initial
            document.getElementById('userAvatar').textContent = user.username.charAt(0).toUpperCase();
            
            // Set avatar color based on role
            const avatar = document.getElementById('userAvatar');
            if (user.role === 'admin') {
                avatar.style.background = 'linear-gradient(45deg, #ff4757, #ff3838)';
            } else if (user.role === 'user') {
                avatar.style.background = 'linear-gradient(45deg, #00d2ff, #3a7bd5)';
            }
        }
        
        // Logout function
        function logout() {
            // Optional: Call backend logout endpoint
            const token = localStorage.getItem('incops_token');
            if (token) {
                fetch('http://localhost:3001/api/logout', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                }).catch(console.error);
            }
            
            // Clear local storage
            localStorage.removeItem('incops_token');
            localStorage.removeItem('incops_user');
            localStorage.removeItem('incops_token_expiry');
            
            // Redirect to login
            window.location.href = 'index.html';
        }
        
        // ==================== API TEST FUNCTIONS ====================
        
        // Test backend health endpoint
        async function testHealthEndpoint() {
            const resultBox = document.getElementById('apiResult');
            resultBox.innerHTML = '<span class="loading"></span> Testing health endpoint...';
            
            try {
                const response = await fetch('http://localhost:3001/api/health');
                const data = await response.json();
                
                resultBox.innerHTML = `
                    <div style="color: #00ff00;">‚úÖ Health Check Successful</div>
                    <pre style="margin-top: 10px;">${JSON.stringify(data, null, 2)}</pre>
                    <small>Status: ${response.status} ${response.statusText}</small>
                `;
                
                // Update backend status in welcome card
                document.getElementById('backendStatus').innerHTML = 
                    `<span style="color: #00ff00;">‚úÖ ${data.message}</span><br>
                     <small>Last checked: ${new Date().toLocaleTimeString()}</small>`;
            } catch (error) {
                resultBox.innerHTML = `
                    <div style="color: #ff4757;">‚ùå Health Check Failed</div>
                    <pre style="margin-top: 10px;">${error.message}</pre>
                `;
            }
        }
        
        // Test protected endpoint (requires JWT)
        async function testProtectedEndpoint() {
            const auth = checkAuth();
            if (!auth) return;
            
            const resultBox = document.getElementById('apiResult');
            resultBox.innerHTML = '<span class="loading"></span> Testing protected endpoint...';
            
            try {
                const response = await fetch('http://localhost:3001/api/profile', {
                    headers: {
                        'Authorization': `Bearer ${auth.token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    resultBox.innerHTML = `
                        <div style="color: #00ff00;">‚úÖ Protected Route Access Granted</div>
                        <pre style="margin-top: 10px;">${JSON.stringify(data, null, 2)}</pre>
                        <small>Status: ${response.status} ${response.statusText}</small>
                    `;
                } else {
                    const error = await response.json();
                    resultBox.innerHTML = `
                        <div style="color: #ff4757;">‚ùå Access Denied</div>
                        <pre style="margin-top: 10px;">${JSON.stringify(error, null, 2)}</pre>
                        <small>Status: ${response.status} ${response.statusText}</small>
                    `;
                    
                    // If token is invalid, logout
                    if (response.status === 401) {
                        setTimeout(logout, 2000);
                    }
                }
            } catch (error) {
                resultBox.innerHTML = `
                    <div style="color: #ff4757;">‚ùå Request Failed</div>
                    <pre style="margin-top: 10px;">${error.message}</pre>
                `;
            }
        }
        
        // Test admin endpoint
        async function testAdminEndpoint() {
            const auth = checkAuth();
            if (!auth) return;
            
            const resultBox = document.getElementById('apiResult');
            resultBox.innerHTML = '<span class="loading"></span> Testing admin endpoint...';
            
            try {
                const response = await fetch('http://localhost:3001/api/admin/users', {
                    headers: {
                        'Authorization': `Bearer ${auth.token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    resultBox.innerHTML = `
                        <div style="color: #00ff00;">‚úÖ Admin Access Granted</div>
                        <pre style="margin-top: 10px;">${JSON.stringify(data, null, 2)}</pre>
                        <small>Status: ${response.status} ${response.statusText}</small>
                    `;
                } else {
                    const error = await response.json();
                    resultBox.innerHTML = `
                        <div style="color: #ffa500;">‚ö†Ô∏è ${error.error || 'Access denied'}</div>
                        <pre style="margin-top: 10px;">${JSON.stringify(error, null, 2)}</pre>
                        <small>Your role: ${auth.user.role}</small>
                    `;
                }
            } catch (error) {
                resultBox.innerHTML = `
                    <div style="color: #ff4757;">‚ùå Request Failed</div>
                    <pre style="margin-top: 10px;">${error.message}</pre>
                `;
            }
        }
        
        // Clear local storage
        function clearLocalStorage() {
            if (confirm('Are you sure you want to clear all local storage data?')) {
                localStorage.clear();
                document.getElementById('apiResult').innerHTML = 
                    '<div style="color: #ffa500;">‚ö†Ô∏è Local storage cleared. Page will reload.</div>';
                setTimeout(() => window.location.reload(), 1500);
            }
        }
        
        // ==================== DASHBOARD FUNCTIONS ====================
        
        // Load recent activity
        async function loadRecentActivity() {
            const auth = checkAuth();
            if (!auth) return;
            
            const activityDiv = document.getElementById('recentActivity');
            activityDiv.innerHTML = '<span class="loading"></span> Loading recent activity...';
            
            try {
                // Mock recent activity (in real app, fetch from API)
                setTimeout(() => {
                    const activities = [
                        { time: 'Just now', action: 'User logged in', user: auth.user.username },
                        { time: '5 min ago', action: 'Security scan completed', status: 'No vulnerabilities found' },
                        { time: '15 min ago', action: 'Deployment initiated', service: 'auth-service v1.2.3' },
                        { time: '1 hour ago', action: 'Database backup completed', size: '2.4 GB' },
                        { time: '2 hours ago', action: 'Monitoring alerts configured', count: '3 new alerts' }
                    ];
                    
                    let html = '<ul style="list-style: none; padding-left: 0;">';
                    activities.forEach(activity => {
                        html += `
                            <li style="margin-bottom: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                <div style="color: #00d2ff; font-weight: bold;">${activity.action}</div>
                                <div style="font-size: 0.9rem; color: #ccc;">
                                    <span>${activity.time}</span>
                                    ${activity.user ? ` ‚Ä¢ By: ${activity.user}` : ''}
                                    ${activity.service ? ` ‚Ä¢ Service: ${activity.service}` : ''}
                                    ${activity.status ? ` ‚Ä¢ Status: ${activity.status}` : ''}
                                </div>
                            </li>
                        `;
                    });
                    html += '</ul>';
                    
                    activityDiv.innerHTML = html;
                }, 500);
            } catch (error) {
                activityDiv.innerHTML = `<div style="color: #ff4757;">Error loading activity: ${error.message}</div>`;
            }
        }
        
        // Load dashboard stats
        function loadDashboardStats() {
            const statsGrid = document.getElementById('statsGrid');
            
            // Mock stats (in real app, fetch from API)
            const stats = [
                { label: 'Active Services', value: '7', color: '#00d2ff' },
                { label: 'Security Scans Today', value: '24', color: '#27ae60' },
                { label: 'Uptime', value: '99.8%', color: '#9b59b6' },
                { label: 'Deployments', value: '12', color: '#e74c3c' }
            ];
            
            let html = '';
            stats.forEach(stat => {
                html += `
                    <div class="stat-card">
                        <div class="stat-value" style="color: ${stat.color}">${stat.value}</div>
                        <div class="stat-label">${stat.label}</div>
                    </div>
                `;
            });
            
            statsGrid.innerHTML = html;
        }
        
        // Check backend status on load
        async function checkBackendStatus() {
            const statusDiv = document.getElementById('backendStatus');
            
            try {
                const response = await fetch('http://localhost:3001/api/health');
                if (response.ok) {
                    const data = await response.json();
                    statusDiv.innerHTML = `
                        <span style="color: #00ff00;">‚úÖ ${data.message}</span><br>
                        <small>Backend: http://localhost:3001 ‚Ä¢ Last checked: ${new Date().toLocaleTimeString()}</small>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <span style="color: #ff4757;">‚ùå Backend not responding</span><br>
                        <small>Status: ${response.status} ${response.statusText}</small>
                    `;
                }
            } catch (error) {
                statusDiv.innerHTML = `
                    <span style="color: #ff4757;">‚ùå Cannot connect to backend</span><br>
                    <small>Error: ${error.message}</small>
                    <div style="margin-top: 10px; font-size: 0.9rem;">
                        Make sure backend is running: <code>npm run dev</code> in backend directory
                    </div>
                `;
            }
        }
        
        // ==================== INITIALIZATION ====================
        
        document.addEventListener('DOMContentLoaded', () => {
            // Check authentication
            const auth = checkAuth();
            if (!auth) return;
            
            // Display user info
            displayUserInfo();
            
            // Load dashboard data
            loadDashboardStats();
            loadRecentActivity();
            checkBackendStatus();
            
            // Auto-refresh backend status every 30 seconds
            setInterval(checkBackendStatus, 30000);
            
            // Auto-refresh activity every 2 minutes
            setInterval(loadRecentActivity, 120000);
            
            // Show welcome message
            console.log(`Welcome ${auth.user.username}! Dashboard loaded successfully.`);
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl+L to logout
            if (e.ctrlKey && e.key === 'l') {
                e.preventDefault();
                logout();
            }
            
            // F5 to refresh dashboard
            if (e.key === 'F5') {
                e.preventDefault();
                loadDashboardStats();
                loadRecentActivity();
                checkBackendStatus();
            }
        });
    </script>
</body>
</html>
